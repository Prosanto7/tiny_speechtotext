{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Commands helper for the Moodle tiny_speechtotext plugin.\n *\n * @module      tiny_speechtotext/commands\n * @copyright   2026\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport {component, buttonName, icon} from './common';\n\nlet recognition = null;\nlet listening = false;\nlet finalTranscript = '';\n\n/**\n * Handle the button action to start/stop speech recognition.\n *\n * @param {Editor} editor The TinyMCE editor instance\n */\nconst handleAction = (editor) => {\n    if (!listening) {\n        // Start listening\n        try {\n            if (!recognition) {\n                initializeRecognition(editor);\n            }\n            recognition.start();\n            listening = true;\n        } catch (e) {\n            window.console.error('Speech recognition start error:', e);\n        }\n    } else {\n        // Stop listening\n        recognition.stop();\n        listening = false;\n    }\n};\n\n/**\n * Initialize the speech recognition.\n *\n * @param {Editor} editor The TinyMCE editor instance\n */\nconst initializeRecognition = (editor) => {\n    // Check if Web Speech API is supported\n    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {\n        window.console.warn(\"Speech API not supported in this browser\");\n        return;\n    }\n\n    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\n    recognition = new SpeechRecognition();\n    recognition.continuous = true;\n    recognition.interimResults = true;\n\n    // Auto language detection from document\n    recognition.lang = document.documentElement.lang || 'en-US';\n\n    // Handle speech recognition results\n    recognition.onresult = (event) => {\n        let interimTranscript = '';\n\n        for (let i = event.resultIndex; i < event.results.length; ++i) {\n            const transcript = event.results[i][0].transcript;\n            if (event.results[i].isFinal) {\n                finalTranscript += transcript + ' ';\n            } else {\n                interimTranscript += transcript;\n            }\n        }\n\n        // Insert the final transcript\n        if (finalTranscript) {\n            editor.insertContent(finalTranscript);\n            finalTranscript = '';\n        }\n    };\n\n    // Handle errors\n    recognition.onerror = (event) => {\n        window.console.error('Speech recognition error:', event.error);\n        listening = false;\n    };\n\n    // Handle end event\n    recognition.onend = () => {\n        listening = false;\n    };\n};\n\n/**\n * Get the setup function for the buttons and menu items.\n *\n * @returns {function} The setup function\n */\nexport const getSetup = async() => {\n    const [\n        buttonText,\n        buttonImage,\n    ] = await Promise.all([\n        getString('buttontitle', component),\n        getButtonImage(icon, component),\n    ]);\n\n    return (editor) => {\n        // Check if Web Speech API is supported\n        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {\n            window.console.warn(\"Speech API not supported in this browser\");\n            return;\n        }\n\n        // Register the icon.\n        editor.ui.registry.addIcon(icon, buttonImage.html);\n\n        // Register the toggle button.\n        editor.ui.registry.addToggleButton(buttonName, {\n            icon: icon,\n            tooltip: buttonText,\n            onAction: () => handleAction(editor),\n            onSetup: (api) => {\n                const updateState = () => {\n                    api.setActive(listening);\n                };\n                \n                // Update state periodically\n                const interval = setInterval(updateState, 100);\n                \n                return () => {\n                    clearInterval(interval);\n                };\n            }\n        });\n\n        // Register the menu item.\n        editor.ui.registry.addMenuItem(buttonName, {\n            icon: icon,\n            text: buttonText,\n            onAction: () => handleAction(editor),\n        });\n    };\n};\n"],"names":["recognition","listening","finalTranscript","handleAction","editor","stop","initializeRecognition","start","e","window","console","error","warn","SpeechRecognition","webkitSpeechRecognition","continuous","interimResults","lang","document","documentElement","onresult","event","interimTranscript","i","resultIndex","results","length","transcript","isFinal","insertContent","onerror","onend","async","buttonText","buttonImage","Promise","all","component","icon","ui","registry","addIcon","html","addToggleButton","buttonName","tooltip","onAction","onSetup","api","interval","setInterval","setActive","clearInterval","addMenuItem","text"],"mappings":";;;;;;;;IA2BIA,YAAc,KACdC,WAAY,EACZC,gBAAkB,SAOhBC,aAAgBC,YACbH,UAaDD,YAAYK,OACZJ,WAAY,WAXHD,aACDM,sBAAsBF,QAE1BJ,YAAYO,QACZN,WAAY,EACd,MAAOO,GACLC,OAAOC,QAAQC,MAAM,kCAAmCH,KAc9DF,sBAAyBF,cAErB,4BAA6BK,WAAa,sBAAuBA,oBACnEA,OAAOC,QAAQE,KAAK,kDAIlBC,kBAAoBJ,OAAOI,mBAAqBJ,OAAOK,wBAC7Dd,YAAc,IAAIa,kBAClBb,YAAYe,YAAa,EACzBf,YAAYgB,gBAAiB,EAG7BhB,YAAYiB,KAAOC,SAASC,gBAAgBF,MAAQ,QAGpDjB,YAAYoB,SAAYC,YAChBC,kBAAoB,OAEnB,IAAIC,EAAIF,MAAMG,YAAaD,EAAIF,MAAMI,QAAQC,SAAUH,EAAG,OACrDI,WAAaN,MAAMI,QAAQF,GAAG,GAAGI,WACnCN,MAAMI,QAAQF,GAAGK,QACjB1B,iBAAmByB,WAAa,IAEhCL,mBAAqBK,WAKzBzB,kBACAE,OAAOyB,cAAc3B,iBACrBA,gBAAkB,KAK1BF,YAAY8B,QAAWT,QACnBZ,OAAOC,QAAQC,MAAM,4BAA6BU,MAAMV,OACxDV,WAAY,GAIhBD,YAAY+B,MAAQ,KAChB9B,WAAY,sBASI+B,gBAEhBC,WACAC,mBACMC,QAAQC,IAAI,EAClB,mBAAU,cAAeC,oBACzB,yBAAeC,aAAMD,4BAGjBjC,SAEE,4BAA6BK,QAAa,sBAAuBA,QAMvEL,OAAOmC,GAAGC,SAASC,QAAQH,aAAMJ,YAAYQ,MAG7CtC,OAAOmC,GAAGC,SAASG,gBAAgBC,mBAAY,CAC3CN,KAAMA,aACNO,QAASZ,WACTa,SAAU,IAAM3C,aAAaC,QAC7B2C,QAAUC,YAMAC,SAAWC,aALG,KAChBF,IAAIG,UAAUlD,aAIwB,WAEnC,KACHmD,cAAcH,cAM1B7C,OAAOmC,GAAGC,SAASa,YAAYT,mBAAY,CACvCN,KAAMA,aACNgB,KAAMrB,WACNa,SAAU,IAAM3C,aAAaC,WA9B7BK,OAAOC,QAAQE,KAAK"}